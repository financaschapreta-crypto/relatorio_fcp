<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Relatório de Pagamentos</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #f2f2f2;
            --text-color: #333;
            --border-color: #ddd;
            --bg-color: #f9f9f9;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            max-width: 1100px;
            width: 100%;
            margin: 20px;
            padding: 30px;
            background-color: #fff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .header {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
            margin-bottom: 20px;
        }
        .header h1, .header h2, .header p {
            margin: 5px 0;
        }
        .header h1 { color: var(--primary-color); font-size: 2.2em; }
        .header h2 { color: var(--text-color); font-size: 1.5em; }

        .input-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: var(--secondary-color);
            border-radius: 8px;
        }
        .input-form div {
            display: flex;
            flex-direction: column;
        }
        .input-form label {
            margin-bottom: 8px;
            font-weight: bold;
        }
        .input-form input, .input-form select {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 1em;
            background-color: #fff;
        }
        .input-form button {
            grid-column: span 1;
            padding: 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s;
            align-self: flex-end;
        }
        .input-form button:hover {
            background-color: #45a049;
        }

        .table-container {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background-color: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: var(--secondary-color);
        }
        .table-actions button {
            padding: 8px 12px;
            margin: 2px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .edit-btn { background-color: #ffc107; color: black; }
        .delete-btn { background-color: #dc3545; color: white; }

        .summary {
            padding: 20px;
            background-color: var(--secondary-color);
            border-radius: 8px;
        }
        .summary h3 {
            margin-top: 0;
            color: var(--text-color);
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .total-geral {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
            margin-top: 15px;
        }

        .report-actions {
            text-align: center;
            margin-top: 30px;
        }
        .report-actions button {
            padding: 15px 40px;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 8px;
            transition: background-color 0.3s;
            margin: 5px;
        }
        .report-actions .pdf-btn {
            background-color: #dc3545;
        }
        .report-actions .pdf-btn:hover {
            background-color: #c82333;
        }
        .report-actions .img-btn {
            background-color: #007bff;
        }
        .report-actions .img-btn:hover {
            background-color: #0056b3;
        }

        /* Estilos para o relatório em imagem */
        #printable-content {
            position: absolute;
            top: -9999px;
            left: -9999px;
            background-color: #fff;
            padding: 30px;
            width: 794px;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
            color: #000;
            font-size: 6pt;
        }

        #printable-content h3 {
            text-align: center;
            margin: 8px 0;
            font-size: 1em;
        }
        #printable-content p {
            text-align: center;
            margin: 4px 0;
            font-size: 0.9em;
        }
        #printable-content table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
        }
        #printable-content th, #printable-content td {
            border: 1px solid #000;
            padding: 4px;
            text-align: left;
            font-size: 1em;
            word-break: break-word;
        }
        #printable-content th {
            background-color: #e0e0e0;
        }
        .printable-summary {
            margin-top: 15px;
        }
        .printable-summary h3 {
            font-size: 1em;
            margin-bottom: 5px;
        }
        .printable-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px solid #000;
            font-size: 1em;
        }
        .printable-summary-item:last-child {
            border-bottom: none;
        }
        .printable-total-geral {
            font-weight: bold;
            font-size: 1.1em;
            margin-top: 8px;
            display: flex;
            justify-content: space-between;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

    <div class="container">
        <div class="header">
            <p>Prefeitura Municipal de Chã Preta/AL</p>
            <h2>Secretaria Municipal de Finanças</h2>
            <p>Data: <span id="data-dia"></span></p>
            <p>Relatório de Pagamento Nº <span id="relatorio-numero"></span></p>
        </div>
        
        <div class="input-form">
            <div>
                <label for="credor">Credor:</label>
                <input type="text" id="credor" placeholder="Nome do Credor" required>
            </div>
            <div>
                <label for="secretaria">Secretaria:</label>
                <select id="secretaria" required>
                    <option value="">Selecione...</option>
                    <option>Sec. de Administração</option>
                    <option>Sec. de Infraestrutura</option>
                    <option>Sec. de Agricultura</option>
                    <option>Sec. de Esporte</option>
                    <option>Sec. de Cultura</option>
                    <option>Sec. de Educação</option>
                    <option>Sec. de Assistência Social</option>
                    <option>Sec. de Saúde</option>
                    <option>Sec. de Governo</option>
                    <option>Gabinete do Prefeito</option>
                    <option>Transferências</option>
                    <option>Outros</option>
                </select>
            </div>
            <div>
                <label for="tipo-recurso">Tipo de Recurso:</label>
                <select id="tipo-recurso" required>
                    <option value="">Selecione...</option>
                    <option>Recurso Próprio</option>
                    <option>Recursos da Merenda</option>
                    <option>Recursos da Educação</option>
                    <option>Recursos da Assistência Social</option>
                    <option>Convênios</option>
                    <option>Emendas Parlamentares</option>
                    <option>Outros Recursos</option>
                </select>
            </div>
            <div>
                <label for="valor">Valor (R$):</label>
                <input type="number" id="valor" placeholder="0.00" step="0.01" required>
            </div>
            <button id="add-btn">Adicionar Pagamento</button>
        </div>

        <div class="table-container">
            <h3>Lançamentos</h3>
            <table id="pagamentos-table-web">
                <thead>
                    <tr>
                        <th>Credor</th>
                        <th>Secretaria</th>
                        <th>Tipo de Recurso</th>
                        <th>Valor</th>
                        <th class="table-actions">Ações</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
        
        <div class="summary">
            <h3>Resumo Financeiro</h3>
            <div class="summary-section">
                <h4>Totais por Recurso:</h4>
                <div id="resumo-recursos"></div>
            </div>
            <div class="summary-section">
                <h4>Totais por Secretaria:</h4>
                <div id="resumo-secretarias"></div>
            </div>
            <div class="summary-section total-geral">
                <h4>Valor Total Geral:</h4>
                <div id="total-geral">R$ 0,00</div>
            </div>
        </div>

        <div class="report-actions">
            <button id="gerar-relatorio-pdf-btn" class="pdf-btn">Gerar Relatório (PDF)</button>
            <button id="gerar-relatorio-img-btn" class="img-btn">Gerar Relatório (Imagem)</button>
        </div>
    </div>

    <div id="printable-content">
        <div class="printable-header" style="text-align: center; margin-bottom: 15px;">
            <h3>Prefeitura Municipal de Chã Preta/AL</h3>
            <h3>Secretaria Municipal de Finanças</h3>
            <p>Data: <span id="img-data-dia"></span></p>
            <p>Relatório de Pagamento Nº <span id="img-relatorio-numero"></span></p>
        </div>
        
        <table id="pagamentos-table-img">
            <thead>
                <tr>
                    <th>Credor</th>
                    <th>Secretaria</th>
                    <th>Tipo de Recurso</th>
                    <th>Valor</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="printable-summary">
            <h3>Resumo Financeiro</h3>
            <div id="img-resumo-recursos"></div>
            <div id="img-resumo-secretarias"></div>
            <div class="printable-total-geral">
                <h4>Valor Total Geral:</h4>
                <div id="img-total-geral"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const dataDia = document.getElementById('data-dia');
            const relatorioNumero = document.getElementById('relatorio-numero');
            const imgDataDia = document.getElementById('img-data-dia');
            const imgRelatorioNumero = document.getElementById('img-relatorio-numero');
            const credorInput = document.getElementById('credor');
            const secretariaSelect = document.getElementById('secretaria');
            const tipoRecursoSelect = document.getElementById('tipo-recurso');
            const valorInput = document.getElementById('valor');
            const addBtn = document.getElementById('add-btn');
            const pagamentosTableWebBody = document.querySelector('#pagamentos-table-web tbody');
            const pagamentosTableImgBody = document.querySelector('#pagamentos-table-img tbody');
            const resumoRecursosDiv = document.getElementById('resumo-recursos');
            const resumoSecretariasDiv = document.getElementById('resumo-secretarias');
            const totalGeralDiv = document.getElementById('total-geral');
            const imgResumoRecursosDiv = document.getElementById('img-resumo-recursos');
            const imgResumoSecretariasDiv = document.getElementById('img-resumo-secretarias');
            const imgTotalGeralDiv = document.getElementById('img-total-geral');
            const gerarRelatorioImgBtn = document.getElementById('gerar-relatorio-img-btn');
            const gerarRelatorioPdfBtn = document.getElementById('gerar-relatorio-pdf-btn');
            let pagamentos = [];
            let editIndex = -1;

            const dataAtual = new Date().toLocaleDateString('pt-BR');
            const relatorioNum = `${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}-${Math.floor(Math.random() * 9000) + 1000}`;
            
            dataDia.textContent = dataAtual;
            relatorioNumero.textContent = relatorioNum;
            imgDataDia.textContent = dataAtual;
            imgRelatorioNumero.textContent = relatorioNum;

            const updateTablesAndSummary = () => {
                pagamentosTableWebBody.innerHTML = '';
                pagamentosTableImgBody.innerHTML = '';

                pagamentos.forEach((pagamento, index) => {
                    const valorFormatado = `R$ ${pagamento.valor.toFixed(2).replace('.', ',')}`;

                    const rowWeb = pagamentosTableWebBody.insertRow();
                    rowWeb.innerHTML = `
                        <td>${pagamento.credor}</td>
                        <td>${pagamento.secretaria}</td>
                        <td>${pagamento.tipoRecurso}</td>
                        <td>${valorFormatado}</td>
                        <td class="table-actions">
                            <button class="edit-btn" onclick="editItem(${index})">Editar</button>
                            <button class="delete-btn" onclick="deleteItem(${index})">Apagar</button>
                        </td>
                    `;
                    const rowImg = pagamentosTableImgBody.insertRow();
                    rowImg.innerHTML = `
                        <td>${pagamento.credor}</td>
                        <td>${pagamento.secretaria}</td>
                        <td>${pagamento.tipoRecurso}</td>
                        <td>${valorFormatado}</td>
                    `;
                });
                updateSummary();
            };

            const updateSummary = () => {
                const resumoRecursos = {};
                const resumoSecretarias = {};
                let totalGeral = 0;

                pagamentos.forEach(pagamento => {
                    const valor = parseFloat(pagamento.valor);
                    resumoRecursos[pagamento.tipoRecurso] = (resumoRecursos[pagamento.tipoRecurso] || 0) + valor;
                    resumoSecretarias[pagamento.secretaria] = (resumoSecretarias[pagamento.secretaria] || 0) + valor;
                    totalGeral += valor;
                });

                resumoRecursosDiv.innerHTML = '';
                resumoSecretariasDiv.innerHTML = '';
                imgResumoRecursosDiv.innerHTML = '';
                imgResumoSecretariasDiv.innerHTML = '';

                for (const recurso in resumoRecursos) {
                    const valorFormatado = `R$ ${resumoRecursos[recurso].toFixed(2).replace('.', ',')}`;
                    const itemWeb = document.createElement('div');
                    itemWeb.className = 'summary-item';
                    itemWeb.innerHTML = `<span>${recurso}:</span> <span>${valorFormatado}</span>`;
                    resumoRecursosDiv.appendChild(itemWeb);
                    
                    const itemImg = document.createElement('div');
                    itemImg.className = 'printable-summary-item';
                    itemImg.innerHTML = `<span>${recurso}:</span> <span>${valorFormatado}</span>`;
                    imgResumoRecursosDiv.appendChild(itemImg);
                }

                for (const secretaria in resumoSecretarias) {
                    const valorFormatado = `R$ ${resumoSecretarias[secretaria].toFixed(2).replace('.', ',')}`;
                    const itemWeb = document.createElement('div');
                    itemWeb.className = 'summary-item';
                    itemWeb.innerHTML = `<span>${secretaria}:</span> <span>${valorFormatado}</span>`;
                    resumoSecretariasDiv.appendChild(itemWeb);

                    const itemImg = document.createElement('div');
                    itemImg.className = 'printable-summary-item';
                    itemImg.innerHTML = `<span>${secretaria}:</span> <span>${valorFormatado}</span>`;
                    imgResumoSecretariasDiv.appendChild(itemImg);
                }

                const totalGeralFormatado = `R$ ${totalGeral.toFixed(2).replace('.', ',')}`;
                totalGeralDiv.textContent = totalGeralFormatado;
                imgTotalGeralDiv.textContent = totalGeralFormatado;
            };

            const clearForm = () => {
                credorInput.value = '';
                secretariaSelect.value = '';
                tipoRecursoSelect.value = '';
                valorInput.value = '';
                editIndex = -1;
                addBtn.textContent = 'Adicionar Pagamento';
            };

            addBtn.addEventListener('click', () => {
                const credor = credorInput.value.trim();
                const secretaria = secretariaSelect.value;
                const tipoRecurso = tipoRecursoSelect.value;
                const valor = parseFloat(valorInput.value);

                if (credor && secretaria && tipoRecurso && !isNaN(valor) && valor > 0) {
                    if (editIndex === -1) {
                        pagamentos.push({ credor, secretaria, tipoRecurso, valor });
                    } else {
                        pagamentos[editIndex] = { credor, secretaria, tipoRecurso, valor };
                    }
                    updateTablesAndSummary();
                    clearForm();
                } else {
                    alert('Por favor, preencha todos os campos corretamente.');
                }
            });

            window.editItem = (index) => {
                const pagamento = pagamentos[index];
                credorInput.value = pagamento.credor;
                secretariaSelect.value = pagamento.secretaria;
                tipoRecursoSelect.value = pagamento.tipoRecurso;
                valorInput.value = pagamento.valor;
                editIndex = index;
                addBtn.textContent = 'Salvar Edição';
            };

            window.deleteItem = (index) => {
                if (confirm('Tem certeza que deseja apagar este pagamento?')) {
                    pagamentos.splice(index, 1);
                    updateTablesAndSummary();
                }
            };
            
            gerarRelatorioImgBtn.addEventListener('click', () => {
                if (pagamentos.length === 0) {
                    alert('Nenhum pagamento adicionado para gerar o relatório.');
                    return;
                }
                const element = document.getElementById('printable-content');
                
                element.style.position = 'static';
                element.style.left = '0';
                element.style.top = '0';

                html2canvas(element, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff'
                }).then(canvas => {
                    element.style.position = 'absolute';
                    element.style.left = '-9999px';
                    element.style.top = '-9999px';

                    const link = document.createElement('a');
                    link.download = `Relatorio_Pagamento_${relatorioNum}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                });
            });

            gerarRelatorioPdfBtn.addEventListener('click', () => {
                if (pagamentos.length === 0) {
                    alert('Nenhum pagamento adicionado para gerar o relatório.');
                    return;
                }
                generatePDFReport();
            });

            function generatePDFReport() {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 15;
                const margin = 10;
                const pageWidth = doc.internal.pageSize.getWidth();

                // Cabeçalho
                doc.setFontSize(12);
                doc.text("PREFEITURA MUNICIPAL DE CHÃ PRETA/AL", pageWidth / 2, y, { align: "center" });
                y += 7;
                doc.setFontSize(10);
                doc.text("Secretaria Municipal de Finanças", pageWidth / 2, y, { align: "center" });
                y += 5;
                doc.setFontSize(8);
                doc.text(`Data: ${dataAtual}`, pageWidth / 2, y, { align: "center" });
                y += 4;
                doc.text(`Relatório de Pagamento Nº ${relatorioNum}`, pageWidth / 2, y, { align: "center" });
                y += 8;
                doc.line(margin, y, pageWidth - margin, y);
                y += 8;

                // Tabela de Lançamentos
                doc.setFontSize(10);
                doc.text("Lançamentos", margin, y);
                y += 5;

                const tableColumn = ["Credor", "Secretaria", "Tipo de Recurso", "Valor"];
                const tableRows = [];
                pagamentos.forEach(p => {
                    tableRows.push([p.credor, p.secretaria, p.tipoRecurso, `R$ ${p.valor.toFixed(2).replace('.', ',')}`]);
                });

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: y,
                    styles: {
                        fontSize: 6,
                        cellPadding: 2,
                        halign: 'left',
                        valign: 'middle'
                    },
                    headStyles: {
                        fillColor: [224, 224, 224],
                        textColor: [0, 0, 0],
                        fontStyle: 'bold'
                    },
                    theme: 'grid',
                    margin: { left: margin, right: margin }
                });

                y = doc.autoTable.previous.finalY + 10;
                
                // Resumo Financeiro
                doc.setFontSize(10);
                doc.text("Resumo Financeiro", margin, y);
                y += 8;

                // Totais por Recurso
                doc.setFontSize(8);
                doc.text("Totais por Recurso:", margin, y);
                y += 4;
                const resumoRecursos = {};
                pagamentos.forEach(p => {
                    resumoRecursos[p.tipoRecurso] = (resumoRecursos[p.tipoRecurso] || 0) + p.valor;
                });
                for (const recurso in resumoRecursos) {
                    doc.text(`${recurso}: R$ ${resumoRecursos[recurso].toFixed(2).replace('.', ',')}`, margin + 5, y);
                    y += 4;
                }
                y += 4;

                // Totais por Secretaria
                doc.setFontSize(8);
                doc.text("Totais por Secretaria:", margin, y);
                y += 4;
                const resumoSecretarias = {};
                pagamentos.forEach(p => {
                    resumoSecretarias[p.secretaria] = (resumoSecretarias[p.secretaria] || 0) + p.valor;
                });
                for (const secretaria in resumoSecretarias) {
                    doc.text(`${secretaria}: R$ ${resumoSecretarias[secretaria].toFixed(2).replace('.', ',')}`, margin + 5, y);
                    y += 4;
                }
                y += 6;

                // Total Geral
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                const totalGeral = pagamentos.reduce((acc, p) => acc + p.valor, 0);
                doc.text(`Valor Total Geral: R$ ${totalGeral.toFixed(2).replace('.', ',')}`, margin, y);

                doc.save(`Relatorio_Pagamento_${relatorioNum}.pdf`);
            }

            updateTablesAndSummary();
        });
    </script>
</body>
</html>