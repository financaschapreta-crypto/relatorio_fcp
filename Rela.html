<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Financeiro - Chã Preta/AL</title>
    <style>
        :root {
            --primary: #1a2a3a;
            --accent: #2980b9;
            --success: #27ae60;
            --bg: #ebedef;
            --warning: #e67e22;
            --danger: #e74c3c;
            --gray: #607d8b;
        }

        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: var(--bg); margin: 0; padding: 10px; font-size: 13px; }
        .wrapper { max-width: 1300px; margin: auto; display: grid; grid-template-columns: 320px 1fr; gap: 15px; }

        /* Painel Lateral */
        .panel { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); height: fit-content; position: sticky; top: 10px; }
        .no-print h2 { font-size: 1.1rem; margin-top: 0; color: var(--primary); border-bottom: 2px solid var(--accent); }
        .form-group { margin-bottom: 8px; }
        label { font-weight: 600; font-size: 0.75rem; color: #555; }
        input, select, textarea { width: 100%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.85rem; }
        textarea { resize: vertical; height: 40px; }

        .btn-add { width: 100%; background: var(--success); color: white; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-print { width: 100%; background: var(--primary); color: white; border: none; padding: 10px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-hist { width: 100%; background: var(--gray); color: white; border: none; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        .btn-save-rel { width: 100%; background: var(--accent); color: white; border: none; padding: 8px; border-radius: 4px; font-weight: bold; cursor: pointer; margin-top: 5px; }
        
        .backup-group { display: flex; gap: 5px; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .btn-backup { flex: 1; font-size: 0.7rem; padding: 5px; cursor: pointer; background: #f8f9fa; border: 1px solid #ccc; border-radius: 3px; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); }
        .modal-content { background: white; margin: 2% auto; padding: 20px; width: 90%; max-width: 800px; border-radius: 8px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid var(--accent); margin-bottom: 15px; }
        
        /* Busca por Período */
        .busca-periodo-container { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 15px; display: flex; align-items: flex-end; gap: 10px; border: 1px solid #ddd; }
        .busca-periodo-container div { flex: 1; }
        .btn-filter { background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-clear { background: #bbb; color: white; border: none; padding: 8px 10px; border-radius: 4px; cursor: pointer; }

        .hist-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; align-items: center; }
        .hist-item:hover { background: #f1f4f6; }

        /* Relatório Ultra-Compacto */
        #folha-relatorio { background: white; padding: 20px; border-radius: 2px; min-height: 297mm; }
        .cabecalho-pref { text-align: center; border-bottom: 1px solid #000; margin-bottom: 10px; padding-bottom: 5px; }
        .cabecalho-pref h1 { margin: 0; font-size: 1.1rem; text-transform: uppercase; }
        .cabecalho-pref p { margin: 1px 0; font-size: 0.8rem; }

        table { width: 100%; border-collapse: collapse; font-size: 0.72rem; line-height: 1.1; }
        th { background: #eee; border: 1px solid #999; padding: 3px 5px; text-transform: uppercase; }
        td { border: 1px solid #ddd; padding: 2px 5px; vertical-align: middle; }
        tr:nth-child(even) { background-color: #fafafa; }
        
        .col-valor { text-align: right; font-family: 'Courier New', monospace; font-weight: bold; width: 80px; }
        .col-acoes { width: 50px; text-align: center; }
        
        .resumos-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .card-resumo { flex: 1; min-width: 200px; border: 1px solid #ddd; padding: 5px; font-size: 0.7rem; }
        .card-resumo h4 { margin: 0 0 5px 0; background: #eee; padding: 2px 5px; font-size: 0.75rem; border-bottom: 1px solid #ddd; }
        .linha-resumo { display: flex; justify-content: space-between; border-bottom: 1px dotted #ccc; margin-bottom: 2px; }

        .footer-rel { margin-top: 30px; text-align: center; font-size: 0.7rem; border-top: 1px solid #000; padding-top: 5px; page-break-inside: avoid; }

        @media print {
            .no-print { display: none !important; }
            body { padding: 0; background: white; }
            .wrapper { display: block; }
            #folha-relatorio { padding: 0; border-radius: 0; box-shadow: none; }
            th { background: #eee !important; -webkit-print-color-adjust: exact; }
            .col-acoes { display: none; }
            table { font-size: 0.65rem; }
            @page { margin: 1cm; }
        }
    </style>
</head>
<body>

<div class="wrapper">
    <div class="panel no-print">
        <h2>Lançamento Financeiro</h2>
        
        <div class="form-group">
            <label>Credor</label>
            <input type="text" id="credor" placeholder="Nome do Credor">
        </div>

        <div class="form-group">
            <label>Lotação</label>
            <select id="lotacao" onchange="checkOutros('lotacao', 'inputLotacao')">
                <option value="Administração">Sec. Mun. de Administração</option>
                <option value="Infraestrutura">Infraestrutura</option>
                <option value="Agricultura">Agricultura</option>
                <option value="Finanças">Finanças</option>
                <option value="Assistência Social">Assistência Social</option>
                <option value="Educação">Educação</option>
                <option value="Saúde">Saúde</option>
                <option value="Governo">Governo</option>
                <option value="Cultura">Cultura</option>
                <option value="Esporte">Esporte</option>
                <option value="Gabinete">Gabinete do Prefeito</option>
                <option value="Funserp">Funserp</option>
                <option value="OUTRO">-- Outro (Digitar) --</option>
            </select>
            <input type="text" id="inputLotacao" style="display:none; margin-top:4px;" placeholder="Nova lotação...">
        </div>

        <div class="form-group">
            <label>Recurso</label>
            <select id="recurso" onchange="checkOutros('recurso', 'inputRecurso')">
                <option value="Rec. Próprio">Rec. Próprio</option>
                <option value="Rec. da Secretaria">Rec. da Secretaria</option>
                <option value="OUTRO">-- Outro (Digitar) --</option>
            </select>
            <input type="text" id="inputRecurso" style="display:none; margin-top:4px;" placeholder="Novo recurso...">
        </div>

        <div class="form-group">
            <label>Valor (R$)</label>
            <input type="number" id="valor" step="0.01">
        </div>

        <div class="form-group">
            <label>Observação Individual</label>
            <textarea id="obs_item" placeholder="Ex: NF 123..."></textarea>
        </div>

        <div class="form-group">
            <label>Relator Responsável</label>
            <select id="responsavel" onchange="atualizarRelatorio()">
                <option value="Eduardo">Eduardo</option>
                <option value="Marcos">Marcos</option>
                <option value="Antônio Victor">Antônio Victor</option>
                <option value="Não Informado">Não Informado</option>
            </select>
        </div>

        <button class="btn-add" id="btnSalvar" onclick="salvarItem()">Adicionar Item</button>
        <button class="btn-save-rel" onclick="salvarNoHistorico()">Finalizar e Salvar Relatório</button>
        <button class="btn-hist" onclick="abrirModal()">Ver Histórico (Período)</button>
        <button class="btn-print" onclick="window.print()">Imprimir PDF</button>

        <div class="backup-group">
            <button class="btn-backup" onclick="exportarBackup()">Gerar Backup</button>
            <button class="btn-backup" onclick="document.getElementById('fileInput').click()">Carregar Backup</button>
            <input type="file" id="fileInput" style="display:none" accept=".json" onchange="importarBackup(event)">
        </div>
    </div>

    <div id="folha-relatorio">
        <div class="cabecalho-pref">
            <h1>Prefeitura Municipal de Chã Preta/AL</h1>
            <p>Secretaria Municipal de Finanças</p>
            <p><strong>Relatório Nº <span id="display-id"></span></strong> | <span id="display-data"></span></p>
        </div>

        <table>
            <thead>
                <tr>
                    <th style="width: 25px;">#</th>
                    <th>Credor</th>
                    <th>Lotação</th>
                    <th>Recurso</th>
                    <th style="width: 150px;">Observação</th>
                    <th class="col-valor">Valor</th>
                    <th class="col-acoes no-print"></th>
                </tr>
            </thead>
            <tbody id="tabela-corpo"></tbody>
            <tfoot>
                <tr style="background: #f2f2f2; font-size: 0.8rem;">
                    <td colspan="5" style="text-align:right"><strong>TOTAL GERAL:</strong></td>
                    <td class="col-valor" id="total-geral">R$ 0,00</td>
                    <td class="no-print"></td>
                </tr>
            </tfoot>
        </table>

        <div class="resumos-container" id="resumos-area"></div>

        <div class="footer-rel">
            <p>RELATÓRIO Nº <span id="display-id-ft"></span> | Emitido por: <span id="display-relator">Eduardo</span></p>
            <p><strong>Secretaria Municipal de Finanças de Chã Preta/AL</strong></p>
        </div>
    </div>
</div>

<div id="modalHistorico" class="modal no-print">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Histórico de Relatórios</h3>
            <span style="cursor:pointer; font-size: 28px; font-weight: bold;" onclick="fecharModal()">&times;</span>
        </div>
        
        <div class="busca-periodo-container">
            <div>
                <label>De:</label>
                <input type="date" id="dataInicio">
            </div>
            <div>
                <label>Até:</label>
                <input type="date" id="dataFim">
            </div>
            <button class="btn-filter" onclick="filtrarHistoricoPorPeriodo()">Filtrar</button>
            <button class="btn-clear" onclick="limparFiltro()">Limpar</button>
        </div>

        <div id="lista-historico"></div>
    </div>
</div>

<script>
    let dados = [];
    let editIndex = null;
    let relId = `${new Date().getFullYear()}${Math.floor(1000 + Math.random() * 9000)}`;

    function checkOutros(selectId, inputId) {
        const s = document.getElementById(selectId);
        const i = document.getElementById(inputId);
        i.style.display = (s.value === "OUTRO") ? "block" : "none";
    }

    function salvarItem() {
        const credor = document.getElementById('credor').value;
        const valor = parseFloat(document.getElementById('valor').value);
        const obs = document.getElementById('obs_item').value;
        let lotacao = document.getElementById('lotacao').value;
        if(lotacao === "OUTRO") lotacao = document.getElementById('inputLotacao').value;
        let recurso = document.getElementById('recurso').value;
        if(recurso === "OUTRO") recurso = document.getElementById('inputRecurso').value;

        if(!credor || isNaN(valor)) return alert("Preencha Credor e Valor!");

        const item = { credor, lotacao, recurso, valor, obs };

        if(editIndex !== null) {
            dados[editIndex] = item;
            editIndex = null;
            document.getElementById('btnSalvar').innerText = "Adicionar Item";
            document.getElementById('btnSalvar').style.background = "var(--success)";
        } else {
            dados.push(item);
        }

        document.getElementById('credor').value = "";
        document.getElementById('valor').value = "";
        document.getElementById('obs_item').value = "";
        document.getElementById('credor').focus();
        atualizarRelatorio();
    }

    function editarItem(index) {
        const item = dados[index];
        document.getElementById('credor').value = item.credor;
        document.getElementById('valor').value = item.valor;
        document.getElementById('obs_item').value = item.obs;
        editIndex = index;
        document.getElementById('btnSalvar').innerText = "Confirmar Edição";
        document.getElementById('btnSalvar').style.background = "var(--warning)";
    }

    function excluirItem(index) {
        if(confirm("Remover este registro?")) {
            dados.splice(index, 1);
            atualizarRelatorio();
        }
    }

    function atualizarRelatorio() {
        document.getElementById('display-id').innerText = relId;
        document.getElementById('display-id-ft').innerText = relId;
        document.getElementById('display-data').innerText = new Date().toLocaleDateString('pt-BR');
        document.getElementById('display-relator').innerText = document.getElementById('responsavel').value;

        const corpo = document.getElementById('tabela-corpo');
        corpo.innerHTML = "";
        
        let total = 0;
        let lotacoes = {};
        let recursos = {};
        let combos = {};

        dados.forEach((item, i) => {
            total += item.valor;
            lotacoes[item.lotacao] = (lotacoes[item.lotacao] || 0) + item.valor;
            recursos[item.recurso] = (recursos[item.recurso] || 0) + item.valor;
            let cKey = `${item.lotacao} + ${item.recurso}`;
            combos[cKey] = (combos[cKey] || 0) + item.valor;

            corpo.innerHTML += `
                <tr>
                    <td style="color:#888">${i+1}</td>
                    <td><strong>${item.credor}</strong></td>
                    <td>${item.lotacao}</td>
                    <td>${item.recurso}</td>
                    <td style="font-style: italic; color: #555;">${item.obs || '-'}</td>
                    <td class="col-valor">${item.valor.toLocaleString('pt-BR', {minimumFractionDigits:2})}</td>
                    <td class="col-acoes no-print">
                        <span style="cursor:pointer; color:blue;" onclick="editarItem(${i})">✎</span>
                        <span style="cursor:pointer; color:red; margin-left:5px;" onclick="excluirItem(${i})">✖</span>
                    </td>
                </tr>`;
        });

        document.getElementById('total-geral').innerText = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits:2})}`;
        let htmlR = renderCard("Por Lotação", lotacoes);
        htmlR += renderCard("Por Recurso", recursos);
        htmlR += renderCard("Lotação + Recurso", combos);
        document.getElementById('resumos-area').innerHTML = htmlR;
    }

    function renderCard(titulo, objeto) {
        let h = `<div class="card-resumo"><h4>${titulo}</h4>`;
        for(let k in objeto) {
            h += `<div class="linha-resumo"><span>${k}</span> <span>R$ ${objeto[k].toLocaleString('pt-BR', {minimumFractionDigits:2})}</span></div>`;
        }
        return h + `</div>`;
    }

    // --- SISTEMA DE HISTÓRICO E BACKUP ---

    function salvarNoHistorico() {
        if (dados.length === 0) return alert("Adicione itens antes de salvar!");
        
        const historico = JSON.parse(localStorage.getItem('financas_cha_preta') || '[]');
        
        // Salvamos o timestamp para facilitar a busca por período depois
        const novoRelatorio = {
            id: relId,
            timestamp: new Date().getTime(),
            dataExibicao: new Date().toLocaleDateString('pt-BR'),
            relator: document.getElementById('responsavel').value,
            total: document.getElementById('total-geral').innerText,
            itens: [...dados]
        };

        historico.push(novoRelatorio);
        localStorage.setItem('financas_cha_preta', JSON.stringify(historico));
        
        alert("Relatório salvo no histórico!");
        dados = [];
        relId = `${new Date().getFullYear()}${Math.floor(1000 + Math.random() * 9000)}`;
        atualizarRelatorio();
    }

    function abrirModal() {
        document.getElementById('modalHistorico').style.display = 'block';
        renderizarListaHistorico();
    }

    function fecharModal() {
        document.getElementById('modalHistorico').style.display = 'none';
    }

    function renderizarListaHistorico(dadosFiltrados = null) {
        const historico = dadosFiltrados || JSON.parse(localStorage.getItem('financas_cha_preta') || '[]');
        const container = document.getElementById('lista-historico');
        container.innerHTML = historico.length ? "" : "<p style='padding:20px; text-align:center;'>Nenhum relatório encontrado para este período.</p>";

        // Inverte para mostrar os mais recentes primeiro
        const listaParaExibir = dadosFiltrados ? historico : [...historico].reverse();

        listaParaExibir.forEach((rel, index) => {
            // Se for filtrado, precisamos achar o index original para ações de carregar/excluir
            const historicoOriginal = JSON.parse(localStorage.getItem('financas_cha_preta') || '[]');
            const indexOriginal = historicoOriginal.findIndex(item => item.id === rel.id && item.timestamp === rel.timestamp);

            container.innerHTML += `
                <div class="hist-item">
                    <div>
                        <strong>Nº ${rel.id}</strong> - <small>${rel.dataExibicao}</small><br>
                        <span style="font-size:0.75rem; color:#666">Resp: ${rel.relator} | Total: ${rel.total}</span>
                    </div>
                    <div>
                        <button onclick="carregarHistorico(${indexOriginal})" style="background:var(--accent); color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer;">Abrir</button>
                        <button onclick="excluirHistorico(${indexOriginal})" style="background:var(--danger); color:white; border:none; padding:5px 10px; border-radius:3px; cursor:pointer; margin-left:5px;">✖</button>
                    </div>
                </div>
            `;
        });
    }

    function filtrarHistoricoPorPeriodo() {
        const strInicio = document.getElementById('dataInicio').value;
        const strFim = document.getElementById('dataFim').value;

        if(!strInicio || !strFim) return alert("Selecione as duas datas para o período!");

        // Ajustar datas para início e fim do dia
        const dInicio = new Date(strInicio + 'T00:00:00').getTime();
        const dFim = new Date(strFim + 'T23:59:59').getTime();

        const historico = JSON.parse(localStorage.getItem('financas_cha_preta') || '[]');
        
        const filtrados = historico.filter(rel => {
            return rel.timestamp >= dInicio && rel.timestamp <= dFim;
        });

        renderizarListaHistorico(filtrados.reverse());
    }

    function limparFiltro() {
        document.getElementById('dataInicio').value = "";
        document.getElementById('dataFim').value = "";
        renderizarListaHistorico();
    }

    function carregarHistorico(index) {
        const historico = JSON.parse(localStorage.getItem('financas_cha_preta') || '[]');
        const selecionado = historico[index];
        if(confirm(`Carregar Relatório Nº ${selecionado.id}? Dados atuais não salvos serão perdidos.`)) {
            dados = selecionado.itens;
            relId = selecionado.id;
            document.getElementById('responsavel').value = selecionado.relator;
            atualizarRelatorio();
            fecharModal();
        }
    }

    function excluirHistorico(index) {
        if(confirm("Excluir definitivamente este relatório do histórico?")) {
            let historico = JSON.parse(localStorage.getItem('financas_cha_preta') || '[]');
            historico.splice(index, 1);
            localStorage.setItem('financas_cha_preta', JSON.stringify(historico));
            renderizarListaHistorico();
        }
    }

    function exportarBackup() {
        const historico = localStorage.getItem('financas_cha_preta');
        if(!historico || historico === "[]") return alert("Não há dados para exportar.");
        
        const blob = new Blob([historico], {type: "application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `backup_financeiro_cha_preta_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.json`;
        a.click();
    }

    function importarBackup(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importado = JSON.parse(e.target.result);
                if(confirm("Deseja importar este backup? Os dados serão adicionados ao seu histórico atual.")) {
                    const atual = JSON.parse(localStorage.getItem('financas_cha_preta') || '[]');
                    const novoHist = [...atual, ...importado];
                    localStorage.setItem('financas_cha_preta', JSON.stringify(novoHist));
                    alert("Dados importados com sucesso!");
                    if(document.getElementById('modalHistorico').style.display === 'block') renderizarListaHistorico();
                }
            } catch (err) {
                alert("Erro ao ler o arquivo. Certifique-se que é um backup válido.");
            }
        };
        reader.readAsText(file);
    }

    // Inicialização
    atualizarRelatorio();
</script>

</body>
</html>
